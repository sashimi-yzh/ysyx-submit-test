From 46d450d342e727e33893ce7e7476628e5181d415 Mon Sep 17 00:00:00 2001
From: kuikuikuizzZ <kimmmywu@gmail.com>
Date: Fri, 8 Aug 2025 10:46:39 +0800
Subject: [PATCH 13/23] feat(soc): add gpio

---
 src/device/Const.scala |  7 ++++
 src/device/GPIO.scala  | 78 +++++++++++++++++++++++++++++++++++++++++-
 2 files changed, 84 insertions(+), 1 deletion(-)

diff --git a/src/device/Const.scala b/src/device/Const.scala
index 5abf4a3..fe9a708 100644
--- a/src/device/Const.scala
+++ b/src/device/Const.scala
@@ -17,8 +17,15 @@ trait AddrConst {
   val SPI_TX0       =     0x00.asUInt(32.W)
   val SPI_SS        =     0x18.asUInt(32.W)   
   val SPI_SS_FLASH  =     0x01.asUInt(8.W)     
+
   // val PSRAM_BASE    =     0x80000000.asUInt(32.W)
   // val PSRAM_SIZE    =     0x20000000.asUInt(32.W)
+
+  // GPIO
+  val GPIO_BASE      =     0x10002000.asUInt(32.W)
+  val GPIO_LED       =     GPIO_BASE+0x00.asUInt(32.W)
+  val GPIO_SWITCH    =     GPIO_BASE+0x04.asUInt(32.W)
+  val GPIO_SEG       =     GPIO_BASE+0x08.asUInt(32.W)
 }
 
 trait SPICmdConst {
diff --git a/src/device/GPIO.scala b/src/device/GPIO.scala
index f770e96..6671117 100644
--- a/src/device/GPIO.scala
+++ b/src/device/GPIO.scala
@@ -8,6 +8,7 @@ import org.chipsalliance.cde.config.Parameters
 import freechips.rocketchip.diplomacy._
 import freechips.rocketchip.util._
 
+import ysyx.Constants._
 class GPIOIO extends Bundle {
   val out = Output(UInt(16.W))
   val in = Input(UInt(16.W))
@@ -25,8 +26,83 @@ class gpio_top_apb extends BlackBox {
   val io = IO(new GPIOCtrlIO)
 }
 
+
+class Bcd16seg extends Module {
+    val io = IO(new Bundle {
+        val code = Input(UInt(4.W))
+        val seg = Output(UInt(8.W))
+    })
+    val result = Wire(UInt(8.W))
+    result := 0.U
+    switch (io.code) {
+        is (0.U)    { result := "b11111101".U};
+        is (1.U)    { result := "b01100000".U};
+        is (2.U)    { result := "b11011010".U};
+        is (3.U)    { result := "b11110010".U};
+        is (4.U)    { result := "b01100110".U};
+        is (5.U)    { result := "b10110110".U};
+        is (6.U)    { result := "b10111110".U};
+        is (7.U)    { result := "b11100000".U};
+        is (8.U)    { result := "b11111110".U};
+        is (9.U)    { result := "b11110110".U};
+        is ("ha".U) { result := "b11101110".U};
+        is ("hb".U) { result := "b00111110".U};
+        is ("hc".U) { result := "b10011100".U};
+        is ("hd".U) { result := "b01111010".U};
+        is ("he".U) { result := "b10011110".U};
+        is ("hf".U) { result := "b10001110".U};
+    }
+    io.seg := ~result
+}
+
 class gpioChisel extends Module {
   val io = IO(new GPIOCtrlIO)
+  val write_valid   =   io.in.pwrite && io.in.psel && io.in.penable
+  val read_valid    =   !io.in.pwrite && io.in.psel && io.in.penable
+  val align_data    =   io.in.pwdata << (io.in.paddr(1,0) << 3)
+  val addr          =   Cat(io.in.paddr(31,2),0.U(2.W)) 
+  val mask          =   io.in.pstrb << io.in.paddr(1,0)
+  val led_reg       =   RegInit(0.U(16.W))
+  val switch_reg    =   RegInit(0.U(16.W))
+  val seg_reg       =   RegInit(0.U(32.W))
+  val seg_decoders  =   VecInit(Seq.fill(8)(Module(new Bcd16seg).io))
+
+
+
+  // 生成字节级掩码（每8位对应1个掩码位）
+  val byteMasks = Wire(Vec(4, UInt(8.W)))
+  val fullMask = byteMasks.asUInt  // 合并为完整数据宽度的掩码
+  for (i <- 0 until 4) {
+    byteMasks(i) := Mux(mask(i), 0xFF.U, 0x00.U)  // 使能时全掩码，否则清零[2](@ref)
+  }
+  io.gpio.out := led_reg
+  io.in.pready := io.in.psel && io.in.penable
+  io.in.pslverr := false.B
+  io.in.prdata := Mux(addr === GPIO_SWITCH,Cat(0.U(16.W),
+                  (switch_reg  << (io.in.paddr(1,0) << 3))),0.U)
+
+  switch_reg := io.gpio.in
+  for (i <- 0 until 8) {
+    io.gpio.seg(i) := seg_decoders(i).seg
+  }
+  for (i <- 0 until 8) {
+    seg_decoders(i).code := seg_reg(i*4+3,i*4)
+  }
+
+  when(write_valid && addr === GPIO_LED){
+    led_reg := (led_reg & ~fullMask(15,0)) | (align_data & fullMask(15,0)) 
+  }.otherwise{
+    led_reg := led_reg
+  }
+
+  when(write_valid && addr === GPIO_SEG){
+    seg_reg :=  (seg_reg & ~fullMask) | (align_data & fullMask) 
+  }.otherwise{
+    seg_reg := seg_reg
+  }
+
+
+
 }
 
 class APBGPIO(address: Seq[AddressSet])(implicit p: Parameters) extends LazyModule {
@@ -43,7 +119,7 @@ class APBGPIO(address: Seq[AddressSet])(implicit p: Parameters) extends LazyModu
     val (in, _) = node.in(0)
     val gpio_bundle = IO(new GPIOIO)
 
-    val mgpio = Module(new gpio_top_apb)
+    val mgpio = Module(new gpioChisel)
     mgpio.io.clock := clock
     mgpio.io.reset := reset
     mgpio.io.in <> in
-- 
2.43.0

