From a18589784ccf12a30000449815620c45a075db25 Mon Sep 17 00:00:00 2001
From: "wuwenhui.wuwh" <wuwenhui.wuwh@bytedance.com>
Date: Sun, 27 Jul 2025 20:19:11 +0800
Subject: [PATCH 02/23] feat(soc): support flash xip

---
 perip/spi/rtl/spi_defines.v |   6 +-
 src/device/SPI.scala        | 234 +++++++++++++++++++++++++++++++++++-
 2 files changed, 233 insertions(+), 7 deletions(-)

diff --git a/perip/spi/rtl/spi_defines.v b/perip/spi/rtl/spi_defines.v
index 96a7d6d..d1ebf37 100644
--- a/perip/spi/rtl/spi_defines.v
+++ b/perip/spi/rtl/spi_defines.v
@@ -67,10 +67,10 @@
 // SPI_MAX_CHAR_32, SPI_MAX_CHAR_24, SPI_MAX_CHAR_16, SPI_MAX_CHAR_8.
 //
 // `define SPI_MAX_CHAR_128
-//`define SPI_MAX_CHAR_64
+`define SPI_MAX_CHAR_64
 // `define SPI_MAX_CHAR_32
 // `define SPI_MAX_CHAR_24
-`define SPI_MAX_CHAR_16
+// `define SPI_MAX_CHAR_16
 // `define SPI_MAX_CHAR_8
 
 `ifdef SPI_MAX_CHAR_128
@@ -155,5 +155,5 @@
 `define SPI_CTRL_RX_NEGEDGE     9
 `define SPI_CTRL_GO             8
 `define SPI_CTRL_RES_1          7
-`define SPI_CTRL_CHAR_LEN       3:0
+`define SPI_CTRL_CHAR_LEN       5:0
 
diff --git a/src/device/SPI.scala b/src/device/SPI.scala
index c354bb9..c073d5b 100644
--- a/src/device/SPI.scala
+++ b/src/device/SPI.scala
@@ -8,6 +8,8 @@ import org.chipsalliance.cde.config.Parameters
 import freechips.rocketchip.diplomacy._
 import freechips.rocketchip.util._
 
+import ysyx.Constants._
+
 class SPIIO(val ssWidth: Int = 8) extends Bundle {
   val sck = Output(Bool())
   val ss = Output(UInt(ssWidth.W))
@@ -42,11 +44,235 @@ class APBSPI(address: Seq[AddressSet])(implicit p: Parameters) extends LazyModul
   class Impl extends LazyModuleImp(this) {
     val (in, _) = node.in(0)
     val spi_bundle = IO(new SPIIO)
-
+    
     val mspi = Module(new spi_top_apb)
     mspi.io.clock := clock
     mspi.io.reset := reset
-    mspi.io.in <> in
+    mspi.io.in    := DontCare
+    // mspi.io.in <> in
     spi_bundle <> mspi.io.spi
-  }
-}
+
+    val counter = RegInit(0.U(2.W))
+    val s_idle :: s_wait_set_ctrl_ready :: s_wait_ss_ready ::s_addr :: s_wait_ctrl_clean :: s_read :: s_read_result :: Nil = Enum(7)
+    val is_flash_read = !in.pwrite && in.paddr >= FLASH_BASE && in.paddr < FLASH_BASE + FLASH_SIZE
+    val state = RegInit(s_idle)
+
+    val paddr   =   RegEnable(in.paddr, state === s_idle && is_flash_read)
+    switch(state) {
+      is(s_idle) {
+          // in.penable and in.psel which is better?
+          when(is_flash_read && in.psel && counter === 0.U) {
+              mspi.io.in.psel     :=  true.B
+              in.prdata := mspi.io.in.prdata
+              in.pready := false.B
+              in.pduser := mspi.io.in.pduser 
+              in.pslverr := mspi.io.in.pslverr
+              counter := counter + 1.U
+            
+          } .elsewhen(is_flash_read && in.psel && counter === 1.U) {
+              mspi.io.in.penable  :=  true.B
+              mspi.io.in.psel     :=  true.B
+
+              mspi.io.in.pwrite   :=  true.B
+              mspi.io.in.paddr    :=  SPI_BASE + SPI_CTRL
+              mspi.io.in.pwdata   :=   0x2040.U
+              mspi.io.in.pprot    :=  in.pprot
+              mspi.io.in.pstrb    :=  0xf.U
+              mspi.io.in.pauser   :=  in.pauser
+              in.pready := false.B
+          } .otherwise {
+            mspi.io.in <> in
+          }
+          when (is_flash_read && mspi.io.in.pready ){
+            counter := counter + 1.U
+          }
+          when (counter === 2.U) {
+            counter := 0.U
+            state := s_wait_set_ctrl_ready
+            mspi.io.in.penable  :=  false.B
+            mspi.io.in.psel     :=  false.B
+            mspi.io.in.pwrite   :=  false.B
+          }
+      }
+      is(s_wait_set_ctrl_ready) {
+          in.prdata := mspi.io.in.prdata
+          in.pready := false.B
+          in.pduser := mspi.io.in.pduser  
+          in.pslverr := mspi.io.in.pslverr 
+
+          when (counter === 0.U){
+            mspi.io.in.psel     :=  true.B
+            mspi.io.in.penable  :=  false.B
+            counter := counter + 1.U
+          } .otherwise{
+            mspi.io.in.penable  :=  true.B
+            mspi.io.in.psel     :=  true.B
+
+            mspi.io.in.pwrite   :=  true.B
+            mspi.io.in.paddr    :=  SPI_BASE + SPI_SS
+            mspi.io.in.pwdata   :=  SPI_SS_FLASH
+            mspi.io.in.pprot    :=  in.pprot
+            mspi.io.in.pstrb    :=  0xf.U
+            mspi.io.in.pauser   :=  in.pauser
+          }
+          when(mspi.io.in.pready ){
+            counter := counter + 1.U
+          }
+          when (counter === 2.U) {
+            counter := 0.U
+            state := s_wait_ss_ready
+            mspi.io.in.penable  :=  false.B
+            mspi.io.in.psel     :=  false.B
+            mspi.io.in.pwrite   :=  false.B
+          }
+      }
+      is(s_wait_ss_ready) {
+          in.prdata := mspi.io.in.prdata
+          in.pready := false.B
+          in.pduser := mspi.io.in.pduser  
+          in.pslverr := mspi.io.in.pslverr 
+
+          when (counter === 0.U){
+            mspi.io.in.psel     :=  true.B
+            mspi.io.in.penable  :=  false.B
+            counter := counter + 1.U
+          } .otherwise{
+            mspi.io.in.penable  :=  true.B
+            mspi.io.in.psel     :=  true.B
+            mspi.io.in.pwrite   :=  true.B
+            mspi.io.in.paddr    :=  SPI_BASE + SPI_TX1
+            mspi.io.in.pwdata   :=  Cat(0x03.U(8.W),paddr(23,0))
+            mspi.io.in.pprot    :=  in.pprot
+            mspi.io.in.pstrb    :=  0xf.U
+            mspi.io.in.pauser   :=  in.pauser
+          }
+
+          when(mspi.io.in.pready ){
+            counter := counter + 1.U
+          }
+          when (counter === 2.U) {
+            counter := 0.U
+            state := s_addr
+            mspi.io.in.penable  :=  false.B
+            mspi.io.in.psel     :=  false.B
+            mspi.io.in.pwrite   :=  false.B
+          }
+      }
+      is(s_addr) {
+          in.prdata := mspi.io.in.prdata
+          in.pready := false.B
+          in.pduser := mspi.io.in.pduser 
+          in.pslverr := mspi.io.in.pslverr 
+          when (counter === 0.U){
+            mspi.io.in.psel     :=  true.B
+            mspi.io.in.penable  :=  false.B
+            counter := counter + 1.U
+          } .otherwise{
+            mspi.io.in.penable  :=  true.B
+            mspi.io.in.psel     :=  true.B
+            
+            mspi.io.in.pwrite   :=  true.B
+            mspi.io.in.paddr    :=  SPI_BASE + SPI_CTRL
+            mspi.io.in.pwdata   :=  0x100.U
+            mspi.io.in.pprot    :=  in.pprot
+            mspi.io.in.pstrb    :=  0xf.U
+            mspi.io.in.pauser   :=  in.pauser
+          }
+          
+          when(mspi.io.in.pready ){
+            counter := counter + 1.U
+          }
+          when (counter === 2.U) {
+            mspi.io.in.psel     :=  false.B
+            mspi.io.in.penable  :=  false.B
+            mspi.io.in.pwrite   :=  false.B
+            counter := 0.U
+            state := s_wait_ctrl_clean
+          }
+      }
+      is(s_wait_ctrl_clean) {
+          in.pready := false.B
+          in.pduser := mspi.io.in.pduser 
+          in.pslverr := mspi.io.in.pslverr 
+          when (counter === 0.U){
+            mspi.io.in.psel     :=  true.B
+            mspi.io.in.penable  :=  false.B
+            counter := counter + 1.U
+          } .otherwise{
+            mspi.io.in.penable  :=  true.B
+            mspi.io.in.psel     :=  true.B
+            
+            mspi.io.in.pwrite   :=  false.B
+            mspi.io.in.paddr    :=  SPI_BASE + SPI_CTRL
+            // mspi.io.in.pwdata   :=  0x100.U
+            mspi.io.in.pprot    :=  in.pprot
+            mspi.io.in.pstrb    :=  0xf.U
+            mspi.io.in.pauser   :=  in.pauser
+          }
+          
+          when(mspi.io.in.pready && ((mspi.io.in.prdata & 0x100.U) === 0.U) ) {
+            counter := counter + 1.U
+          }
+          when (counter === 2.U) {
+            mspi.io.in.penable  :=  false.B
+            mspi.io.in.psel     :=  false.B
+            counter := 0.U
+            state := s_read
+          }
+      }
+      is(s_read) {
+          in.prdata := mspi.io.in.prdata
+          in.pready := false.B
+          in.pduser := mspi.io.in.pduser 
+          in.pslverr := mspi.io.in.pslverr 
+          when (counter === 0.U){
+            mspi.io.in.psel     :=  true.B
+            counter := counter + 1.U
+          } .otherwise{
+            mspi.io.in.penable  :=  true.B
+            mspi.io.in.psel     :=  true.B
+            mspi.io.in.pwrite   :=  false.B
+            mspi.io.in.paddr    :=  SPI_BASE + SPI_RX0
+            // mspi.io.in.pwdata   :=  0x100.U
+
+            mspi.io.in.pprot    :=  in.pprot
+            mspi.io.in.pstrb    :=  in.pstrb
+            mspi.io.in.pauser   :=  in.pauser
+          }
+          
+          when(mspi.io.in.pready ) {
+            counter := counter + 1.U
+            in.prdata := mspi.io.in.prdata
+          }
+          when (counter === 2.U) {
+            mspi.io.in.psel     :=  false.B
+            mspi.io.in.penable     :=  false.B
+            in.pready := true.B
+            counter := 0.U
+            in.prdata := mspi.io.in.prdata
+            in.pduser := mspi.io.in.pduser 
+            in.pslverr := mspi.io.in.pslverr 
+            state := s_idle
+          }
+      }
+      // is(s_read_result) {
+      //   when(mspi.io.in.pready) {
+      //     mspi.io.in.penable := false.B
+      //     mspi.io.in.psel    := false.B
+          
+      //     mspi.io.in.pwrite   :=  false.B
+      //     mspi.io.in.paddr    :=  SPI_BASE + SPI_RX0
+      //     // mspi.io.in.pwdata   :=  0x100.U
+      //     mspi.io.in.pprot    :=  in.pprot
+      //     mspi.io.in.pstrb    :=  in.pstrb
+      //     mspi.io.in.pauser   :=  in.pauser
+
+      //     in.pduser := mspi.io.in.pduser 
+      //     in.pslverr := mspi.io.in.pslverr 
+      //     state := s_idle
+      //   }
+      // }
+    }
+     
+  } 
+}
\ No newline at end of file
-- 
2.43.0

