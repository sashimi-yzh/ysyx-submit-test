From f078865264af22d409d359eb08e3131796573532 Mon Sep 17 00:00:00 2001
From: 11111-dongfengjun <dongfengjun2024@163.com>
Date: Sun, 21 Sep 2025 17:04:17 +0800
Subject: [PATCH 1/3] CI

---
 bsp/abstract-machine/Makefile      |  4 +-
 bsp/abstract-machine/src/context.c | 67 +++++++++++++++++++++++++-----
 bsp/abstract-machine/src/uart.c    |  5 ++-
 3 files changed, 63 insertions(+), 13 deletions(-)
 mode change 100644 => 100755 bsp/abstract-machine/src/uart.c

diff --git a/bsp/abstract-machine/Makefile b/bsp/abstract-machine/Makefile
index 8d70f310b..b45a171b0 100644
--- a/bsp/abstract-machine/Makefile
+++ b/bsp/abstract-machine/Makefile
@@ -8,7 +8,9 @@ NAME = rtthread
 SRCS = $(shell find src -name "*.c")
 CFLAGS += -DHAVE_CCONFIG_H -D__RTTHREAD__
 CFLAGS += -Wno-nonnull-compare
-LDFLAGS += -T extra.ld
+ifneq ($(ARCH),riscv32e-ysyxsoc)
+	LDFLAGS += -T extra.ld
+endif
 -include $(FILE_MK)
 -include $(AM_APPS_MK)
 include $(AM_HOME)/Makefile
diff --git a/bsp/abstract-machine/src/context.c b/bsp/abstract-machine/src/context.c
index ee38829ae..e74ab8af6 100644
--- a/bsp/abstract-machine/src/context.c
+++ b/bsp/abstract-machine/src/context.c
@@ -2,30 +2,77 @@
 #include <klib.h>
 #include <rtthread.h>
 
-static Context* ev_handler(Event e, Context *c) {
+static Context* event_handler(Event e, Context *c) {
+  rt_thread_t current_thread = rt_thread_self();
+  uintptr_t *saved_context_ptr; 
   switch (e.event) {
-    default: printf("Unhandled event ID = %d\n", e.event); assert(0);
-  }
-  return c;
+    case EVENT_YIELD:
+      rt_ubase_t *thread_data = (rt_ubase_t *)current_thread->user_data;  
+      if(thread_data[2] != 0) {
+				saved_context_ptr = (uintptr_t *)thread_data[2];
+        *saved_context_ptr = (uintptr_t)c;
+      }      
+      current_thread->user_data = thread_data[0];
+			c = (Context *)*(uintptr_t *)thread_data[1];
+      break;
+		case EVENT_ERROR:
+			break;
+    default:
+      printf("Unhandled event ID = %d\n", e.event);
+      assert(0);
+    }
+    return c;
 }
 
 void __am_cte_init() {
-  cte_init(ev_handler);
+    cte_init(event_handler);
 }
 
 void rt_hw_context_switch_to(rt_ubase_t to) {
-  assert(0);
+    rt_thread_t current_thread = rt_thread_self();
+    rt_ubase_t *thread_switch_data = (rt_ubase_t *)((Context *)to - 2);
+    thread_switch_data[0] = current_thread->user_data;
+    thread_switch_data[1] = to;
+    thread_switch_data[2] = 0;
+    current_thread->user_data = (rt_ubase_t)thread_switch_data;
+    
+    yield();
 }
 
 void rt_hw_context_switch(rt_ubase_t from, rt_ubase_t to) {
-  assert(0);
+    rt_thread_t current_thread = rt_thread_self();
+    rt_ubase_t *thread_switch_data = (rt_ubase_t *)((Context *)to - 2);
+    thread_switch_data[0] = current_thread->user_data;
+    thread_switch_data[1] = to;
+    thread_switch_data[2] = from;
+    current_thread->user_data = (rt_ubase_t)thread_switch_data;
+    
+    yield();
 }
 
 void rt_hw_context_switch_interrupt(void *context, rt_ubase_t from, rt_ubase_t to, struct rt_thread *to_thread) {
-  assert(0);
+    assert(0);
+}
+
+void wrap(void *arg) {
+    uintptr_t *args = (uintptr_t *)arg;
+    void (*tentry)(void *) = (void (*)(void *))args[0];
+    void *parameter = (void *)args[1];
+    void (*texit)() = (void (*)())args[2];
+    
+    tentry(parameter);
+    texit();
 }
 
 rt_uint8_t *rt_hw_stack_init(void *tentry, void *parameter, rt_uint8_t *stack_addr, void *texit) {
-  assert(0);
-  return NULL;
+    uintptr_t stack_ptr = (uintptr_t)(stack_addr + sizeof(uintptr_t) - 1) & ~(sizeof(uintptr_t) - 1);
+    uintptr_t *args = (uintptr_t *)((Context *)stack_ptr - 2);
+    args[0] = (uintptr_t)tentry;
+    args[1] = (uintptr_t)parameter;
+    args[2] = (uintptr_t)texit;
+    Area stack;
+		stack.end = (void *)stack_ptr;
+    Context *cp = kcontext(stack, wrap, args);
+
+    return (rt_uint8_t *)cp;
 }
diff --git a/bsp/abstract-machine/src/uart.c b/bsp/abstract-machine/src/uart.c
old mode 100644
new mode 100755
index e4eb86689..8a1178a69
--- a/bsp/abstract-machine/src/uart.c
+++ b/bsp/abstract-machine/src/uart.c
@@ -11,6 +11,7 @@
 #include <rtthread.h>
 #include <am.h>
 #include <klib.h>
+#include <klib-macros.h>
 
 #define UART_DEFAULT_BAUDRATE 115200
 
@@ -37,8 +38,8 @@ static int _uart_putc(struct rt_serial_device *serial, char c) {
 }
 
 static int _uart_getc(struct rt_serial_device *serial) {
-  static const char *p = "help\ndate\nversion\nfree\nps\npwd\nls\nmemtrace\nmemcheck\nutest_list\n";
-  return (*p != '\0' ? *(p ++) : -1);
+  static const char *p = "help\ndate\nversion\nfree\nps\npwd\nls\nmemtrace\nmemcheck\nutest_list\nam_hello\n";//添加命令启动AM程序
+  return (*p != '\0' ? *(p ++) : io_read(AM_UART_CONFIG).present ? io_read(AM_UART_RX).data : -1);
 }
 
 const struct rt_uart_ops _uart_ops = {
-- 
2.43.0

